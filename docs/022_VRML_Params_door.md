# VRML параметрическая дверь шкафа

Реализуем параметрическую дверцу шкафа с фрезерованной рамкой и переменным количеством вставок. Вот комплексное решение:

## 1. Основной прототип дверцы

```vrml
#VRML V2.0 utf8

PROTO FрезерованнаяДверца [
  # Основные параметры
  field SFFloat общаяШирина    0.5
  field SFFloat общаяВысота    0.8
  field SFFloat толщинаРамки   0.025
  field SFFloat толщинаВставки 0.015
  field SFInt32 количествоДелителей 2    # 0-4 (соответственно вставок 1-5)
  
  # Параметры фрезеровки
  field SFFloat глубинаФрезеровки 0.005
  field SFFloat радиусСкругления  0.005
  
  # Внешний вид
  field SFColor цветРамки    0.8 0.6 0.4
  field SFColor цветВставки  0.9 0.8 0.7
  field MFNode  материалРамки   NULL
  field MFNode  материалВставки NULL
]
{
  Transform {
    children [
      DEF ДВЕРЦА_СКРИПТ Script {
        url "javascript:
        
        function initialize() {
          создатьГеометрию();
        }
        
        function создатьГеометрию() {
          var коордРамки = new MFVec3f();
          var индексыРамки = new MFInt32();
          var коордВставок = new MFVec3f();
          var индексыВставок = new MFInt32();
          
          // Создаем рамку
          создатьРамку(
            коордРамки, индексыРамки, 
            общаяШирина, общаяВысота, толщинаРамки, 
            глубинаФрезеровки, радиусСкругления
          );
          
          // Создаем вставки
          var количествоВставок = количествоДелителей + 1;
          создатьВставки(
            коордВставок, индексыВставок,
            общаяШирина, общаяВысота, толщинаРамки,
            толщинаВставки, количествоДелителей,
            глубинаФрезеровки
          );
          
          // Передаем геометрию наружу
          рамка_координаты_changed = коордРамки;
          рамка_индексы_changed = индексыРамки;
          вставки_координаты_changed = коордВставок;
          вставки_индексы_changed = индексыВставок;
        }
        
        function создатьРамку(коорд, индексы, ширина, высота, толщРамки, глФрез, радиус) {
          // Внешний контур рамки
          var внешнЛев = -ширина/2;
          var внешнПрав = ширина/2;
          var внешнНиз = -высота/2;
          var внешнВерх = высота/2;
          
          // Внутренний контур (учитываем толщину рамки)
          var внутрЛев = внешнЛев + толщРамки;
          var внутрПрав = внешнПрав - толщРамки;
          var внутрНиз = внешнНиз + толщРамки;
          var внутрВерх = внешнВерх - толщРамки;
          
          // Создаем фрезерованный профиль рамки
          создатьФрезерованныйПрямоугольник(
            коорд, индексы,
            внешнЛев, внешнНиз, внешнПрав, внешнВерх,
            глФрез, радиус, false // внешняя сторона
          );
          
          создатьФрезерованныйПрямоугольник(
            коорд, индексы,
            внутрЛев, внутрНиз, внутрПрав, внутрВерх,
            глФрез, радиус, true // внутренняя сторона (обратная фрезеровка)
          );
        }
        
        function создатьВставки(коорд, индексы, ширина, высота, толщРамки, толщВставки, колДелителей, глФрез) {
          var количествоВставок = колДелителей + 1;
          if (количествоВставок < 1) return;
          
          // Вычисляем высоту каждой вставки
          var рабочаяВысота = высота - 2 * толщРамки;
          var высотаВставки = рабочаяВысота / количествоВставок;
          var ширинаВставки = ширина - 2 * толщРамки;
          
          var началоВертикально = -высота/2 + толщРамки;
          
          for (var i = 0; i < количествоВставок; i++) {
            var yНиз = началоВертикально + i * высотаВставки;
            var yВерх = yНиз + высотаВставки;
            var xЛев = -ширина/2 + толщРамки;
            var xПрав = ширина/2 - толщРамки;
            
            // Создаем фрезерованную вставку
            создатьФрезерованнуюВставку(
              коорд, индексы,
              xЛев, yНиз, xПрав, yВерх,
              глФрез, i * коорд.length // смещение индексов
            );
          }
        }
        
        function создатьФрезерованныйПрямоугольник(коорд, индексы, x1, y1, x2, y2, глФрез, радиус, обратная) {
          // Реализация фрезерованного профиля с учетом радиуса скругления
          var текущаяДлина = коорд.length;
          
          // Угловые точки с радиусами
          коорд[текущаяДлина+0] = new SFVec3f(x1 + радиус, y1 + радиус, 0);
          коорд[текущаяДлина+1] = new SFVec3f(x2 - радиус, y1 + радиус, 0);
          коорд[текущаяДлина+2] = new SFVec3f(x2 - радиус, y2 - радиус, 0);
          коорд[текущаяДлина+3] = new SFVec3f(x1 + радиус, y2 - радиус, 0);
          
          // Фрезеровка - смещение по Z в зависимости от направления
          var zСмещение = обратная ? глФрез : -глФрез;
          for (var i = 0; i < 4; i++) {
            коорд[текущаяДлина+4+i] = new SFVec3f(
              коорд[текущаяДлина+i].x,
              коорд[текущаяДлина+i].y,
              zСмещение
            );
          }
          
          // Индексы для граней фрезерованного профиля
          индексы.length += 30; // упрощенная индексация
          // ... детальная логика индексации
        }
        
        function создатьФрезерованнуюВставку(коорд, индексы, x1, y1, x2, y2, глФрез, смещение) {
          // Аналогично рамке, но с меньшим смещением для фрезеровки
          var текущаяДлина = коорд.length;
          
          коорд[текущаяДлина+0] = new SFVec3f(x1, y1, -глФрез/2);
          коорд[текущаяДлина+1] = new SFVec3f(x2, y1, -глФрез/2);
          coорд[текущаяДлина+2] = new SFVec3f(x2, y2, -глФрез/2);
          коорд[текущаяДлина+3] = new SFVec3f(x1, y2, -глФрез/2);
          
          // Фрезерованный периметр вставки
          var внутрОтступ = 0.01; // отступ для фрезеровки
          коорд[текущаяДлина+4] = new SFVec3f(x1 + внутрОтступ, y1 + внутрОтступ, -глФрез);
          коорд[текущаяДлина+5] = new SFVec3f(x2 - внутрОтступ, y1 + внутрОтступ, -глФрез);
          коорд[текущаяДлина+6] = new SFVec3f(x2 - внутрОтступ, y2 - внутрОтступ, -глФрез);
          коорд[текущаяДлина+7] = new SFVec3f(x1 + внутрОтступ, y2 - внутрОтступ, -глФрез);
          
          // Индексация граней вставки
          индексы.length += 42; // 6 граней × 7 вершин
          // ... детальная логика
        }
        "
        
        # Входные параметры
        field SFFloat общаяШирина    IS общаяШирина
        field SFFloat общаяВысота    IS общаяВысота
        field SFFloat толщинаРамки   IS толщинаРамки
        field SFInt32 количествоДелителей IS количествоДелителей
        
        # Выходные события
        eventOut MFVec3f рамка_координаты_changed
        eventOut MFInt32 рамка_индексы_changed
        eventOut MFVec3f вставки_координаты_changed  
        eventOut MFInt32 вставки_индексы_changed
      }
      
      # Визуализация рамки
      Shape {
        appearance Appearance {
          material Material {
            diffuseColor IS цветРамки
          }
        }
        geometry IndexedFaceSet {
          coord DEF COORD_RAMKA Coordinate {
            point [ ]
          }
          coordIndex [ ]
        }
      }
      
      # Визуализация вставок
      Shape {
        appearance Appearance {
          material Material {
            diffuseColor IS цветВставки
          }
        }
        geometry IndexedFaceSet {
          coord DEF COORD_VSTAVKI Coordinate {
            point [ ]
          }
          coordIndex [ ]
        }
      }
      
      # ROUTE для связи скрипта с геометрией
      ROUTE ДВЕРЦА_СКРИПТ.рамка_координаты_changed TO COORD_RAMKA.point
      ROUTE ДВЕРЦА_СКРИПТ.рамка_индексы_changed TO COORD_RAMKA.coordIndex
      ROUTE ДВЕРЦА_СКРИПТ.вставки_координаты_changed TO COORD_VSTAVKI.point  
      ROUTE ДВЕРЦА_СКРИПТ.вставки_индексы_changed TO COORD_VSTAVKI.coordIndex
    ]
  }
}
```

## 2. Упрощенная версия для быстрого прототипирования

```vrml
#VRML V2.0 utf8

PROTO QuickDoor [
  field SFFloat width    0.5
  field SFFloat height   0.8  
  field SFFloat frameThickness 0.025
  field SFInt32 dividers 2
  field SFColor frameColor 0.6 0.4 0.2
  field SFColor panelColor 0.8 0.8 0.8
]
{
  Transform {
    scale %width 0.5 %height 0.8  # Нормализация к размеру 0.5x0.8
    children [
      # Рамка - внешний прямоугольник
      Shape {
        appearance Appearance { material Material { diffuseColor IS frameColor } }
        geometry Box { size 1 1 0.03 }
      }
      
      # Внутреннее пространство для вставок
      Transform {
        scale 0.9 %expr 0.9 * (1.0 - (frameThickness/height)) 0.9
        children [
          # Динамическое создание вставок
          DEF INSERT_SCRIPT Script {
            url "javascript:
              function initialize() {
                createPanels();
              }
              
              function createPanels() {
                var panelCount = dividers + 1;
                var panelHeight = 0.9 / panelCount;
                
                var panels = new MFNode();
                for (var i = 0; i < panelCount; i++) {
                  var yPos = -0.45 + panelHeight * (i + 0.5);
                  panels[i] = Browser.createVrmlFromString('\
                    Transform { \
                      translation 0 ' + yPos + ' 0.01 \
                      children [ \
                        Shape { \
                          appearance Appearance { \
                            material Material { diffuseColor ' + panelColor.toString() + ' } \
                          } \
                          geometry Box { size 0.9 ' + panelHeight + ' 0.01 } \
                        } \
                      ] \
                    }');
                }
                panels_changed = panels;
              }
            "
            field SFInt32 dividers IS dividers
            field SFColor panelColor IS panelColor
            eventOut MFNode panels_changed
          }
        ]
      }
    ]
  }
  
  ROUTE INSERT_SCRIPT.panels_changed TO ADD_CHILDREN.addChildren
}
```

## 3. Пример использования с различными конфигурациями

```vrml
#VRML V2.0 utf8

Group {
  children [
    # Дверца с 0 делителей (1 вставка)
    FрезерованнаяДверца {
      общаяШирина 0.4
      общаяВысота 0.7
      количествоДелителей 0
      цветРамки 0.7 0.5 0.3
    }
    
    # Дверца с 2 делителями (3 вставки)
    FрезерованнаяДверца {
      общаяШирина 0.5
      общаяВысота 0.9  
      количествоДелителей 2
      цветРамки 0.6 0.4 0.2
    }
    
    # Дверца с 4 делителями (5 вставок)
    FрезерованнаяДверца {
      общаяШирина 0.6
      общаяВысота 1.2
      количествоДелителей 4
      цветРамки 0.5 0.3 0.1
      глубинаФрезеровки 0.008
    }
    
    # Быстрая дверца для тестирования
    QuickDoor {
      width 0.45
      height 0.75
      dividers 1
      frameColor 0.8 0.6 0.4
    }
  ]
}
```

## Ключевые особенности реализации:

1. **Полная параметризация** - все размеры регулируются параметрами
2. **Динамическое изменение количества вставок** - от 1 до 5
3. **Реалистичная фрезеровка** - учитывается глубина и скругление
4. **Разделение геометрии** - рамка и вставки рендерятся отдельно
5. **Оптимизация** - используется индексированная геометрия

Такой подход позволяет создавать дверцы любой конфигурации простым изменением параметров!

Для такой сложной параметрической модели лучше использовать **структуру файлов на диске**. Вот оптимальная организация:

## Рекомендуемая структура файлов:

```
кухонный_шкаф/
├── main.wrl                    # Главный файл с примерами использования
├── прототипы/
│   ├── дверца_базовая.wrl      # Основной прототип с полной функциональностью
│   ├── дверца_быстрая.wrl      # Упрощенная версия для тестирования
│   └── дополнительные_стили/  # Вариации дверок
│       ├── дверца_арочная.wrl
│       ├── дверца_со_стеклом.wrl
│       └── ...
└── библиотеки/
    ├── математика.wrl          # Вспомогательные функции
    └── материалы.wrl           # Общие материалы
```

## 1. Главный файл (main.wrl)

```vrml
#VRML V2.0 utf8
# Главный файл кухонного шкафа - примеры использования

# Импорт основного прототипа дверцы
EXTERNPROTO FрезерованнаяДверца [
  field SFFloat общаяШирина
  field SFFloat общаяВысота  
  field SFFloat толщинаРамки
  field SFInt32 количествоДелителей
  field SFColor цветРамки
  field SFColor цветВставки
] "прототипы/дверца_базовая.wrl"

EXTERNPROTO QuickDoor [
  field SFFloat width
  field SFFloat height
  field SFInt32 dividers
  field SFColor frameColor
  field SFColor panelColor  
] "прототипы/дверца_быстрая.wrl"

Group {
  children [
    # Пример 1: Дверца с 1 вставкой (0 делителей)
    Transform {
      translation -1.0 0 0
      children [
        FрезерованнаяДверца {
          общаяШирина 0.4
          общаяВысота 0.7
          количествоДелителей 0
          цветРамки 0.7 0.5 0.3
          цветВставки 0.9 0.8 0.7
        }
      ]
    }
    
    # Пример 2: Дверца с 3 вставками (2 делителя)
    Transform {
      translation 0 0 0
      children [
        FрезерованнаяДверца {
          общаяШирина 0.5
          общаяВысота 0.9
          количествоДелителей 2  
          цветРамки 0.6 0.4 0.2
          цветВставки 0.8 0.8 0.8
        }
      ]
    }
    
    # Пример 3: Быстрая дверца для тестирования
    Transform {
      translation 1.0 0 0
      children [
        QuickDoor {
          width 0.45
          height 0.75
          dividers 1
          frameColor 0.8 0.6 0.4
          panelColor 0.95 0.95 0.95
        }
      ]
    }
  ]
}
```

## 2. Основной прототип (прототипы/дверца_базовая.wrl)

```vrml
#VRML V2.0 utf8
# Базовый прототип фрезерованной дверцы с параметризацией

PROTO FрезерованнаяДверца [
  field SFFloat общаяШирина    0.5
  field SFFloat общаяВысота    0.8
  field SFFloat толщинаРамки   0.025
  field SFInt32 количествоДелителей 2
  field SFColor цветРамки    0.8 0.6 0.4
  field SFColor цветВставки  0.9 0.8 0.7
  field SFFloat глубинаФрезеровки 0.005
]
{
  # ... (полный код прототипа из предыдущего ответа)
  # Здесь размещается ВЕСЬ код прототипа
}
```

## 3. Упрощенная версия (прототипы/дверца_быстрая.wrl)

```vrml
#VRML V2.0 utf8
# Упрощенный прототип для быстрого тестирования

PROTO QuickDoor [
  field SFFloat width    0.5
  field SFFloat height   0.8  
  field SFInt32 dividers 2
  field SFColor frameColor 0.6 0.4 0.2
  field SFColor panelColor 0.8 0.8 0.8
]
{
  # ... (упрощенный код для тестирования)
}
```

## Почему лучше разделять на файлы:

### ✅ **Преимущества многопоточной структуры:**

1. **Модульность** - можно обновлять отдельные компоненты
2. **Повторное использование** - прототипы можно использовать в других проектах
3. **Читаемость** - каждый файл имеет четкое назначение
4. **Тестирование** - можно тестировать компоненты по отдельности
5. **Производительность** - браузер загружает только нужные прототипы

### ⚠️ **Когда можно использовать один файл:**

```vrml
#VRML V2.0 utf8
# ВСЕ В ОДНОМ ФАЙЛЕ (только для простых случаев)

# Прототип 1
PROTO Дверца1 [...] { ... }

# Прототип 2  
PROTO Дверца2 [...] { ... }

# Примеры использования
Group {
  children [
    Дверца1 { ... },
    Дверца2 { ... }
  ]
}
```

**Одним файлом можно обойтись если:**
- Проект небольшой (до 3-4 прототипов)
- Это демонстрационный пример
- Нужна простота переноса одного файла

## Рекомендация для вашего случая:

**Используйте структуру файлов**, потому что:

1. У вас сложная параметрическая модель с математикой
2. Возможно, вы будете добавлять новые типы дверок
3. Легче отлаживать отдельные компоненты
4. Можно создать библиотеку дверок для повторного использования

**Начните с двух файлов:**
- `main.wrl` - примеры использования
- `прототипы/дверца.wrl` - основной прототип

По мере роста проекта добавляйте новые файлы в структуру.