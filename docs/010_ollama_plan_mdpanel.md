# План завершения модуля mDPanel

---

## 1. Общая архитектура
| Слой | Ответственность | Текущий статус | Что добавить |
|------|------------------|----------------|--------------|
| **Domain (Entities)** | Описание бизнес‑объектов (панель, вырезы, вставки, кромки, крепеж, отделка, фрезеровка) | Полностью реализовано | Новые сущности **PolyInfo**, **PathInfo**, **ElemsInfo**, **FixInfoElems** |
| **Use‑cases (Application layer)** | Операции над сущностями (создание, валидация, расчёт) | Тесты use‑cases есть | Расширить use‑cases для новых сущностей и чтения свойств из K3 |
| **Interface (Ports)** | Абстракции внешних систем (K3‑файлы, CAD‑модели) | `K3Interface` готов, `K3Implementation` содержит заглушки | Заполнить все методы, используя логику из `PanelRectangle` |
| **Infrastructure** | Конкретные адаптеры (чтение/запись K3, логирование) | Частично реализовано | Добавить адаптеры для новых сущностей, обеспечить единый сервис чтения свойств панели |

---

## 2. Дизайн недостающих классов
| Класс | Предназначение | Атрибуты | Методы |
|-------|----------------|----------|--------|
| **PolyInfo** | Информация о полигоне (контур панели) | `points: List[Tuple[float,float]]`, `closed: bool` | `area()`, `perimeter()`, `contains(point)` |
| **PathInfo** | Описание пути (контур выреза/вставки) | `segments: List[Segment]` (type, start, end) | `length()`, `is_closed()` |
| **ElemsInfo** | Сводка всех элементов (вырезы, вставки, кромки, крепеж) | `cuts`, `inserts`, `edges`, `fasteners` | `total_volume()`, `validate()` |
| **FixInfoElems** | Параметры крепежных элементов (позиция, тип, ориентация) | `fixes: List[Fix]` (type, coords, angle) | `group_by_type()`, `export_k3()` |

Все классы реализуют `__repr__`, `__eq__`, сериализацию/десериализацию в/из формата K3.

---

## 3. Перенос логики `PanelRectangle` из `drawprof/mPanel.py`
1. **Исследовать `PanelRectangle`** – там парсится размер, атрибуты `poly`, `path`, `elems`, `fixes`.
2. **Создать сервис `PanelPropertyReader`** (`src/Proto/mDPanel/infrastructure/`):
   * `read_from_k3(k3_file: Path) -> Panel`
   * Открывает K3‑файл, ищет секцию `PanelRectangle`, использует парсеры для `PolyInfo`, `PathInfo`, `ElemsInfo`, `FixInfoElems`.
3. **Интегрировать в `K3Implementation`**:
   * `def get_panel(self, panel_id: str) -> Panel:` → вызывает `PanelPropertyReader.read_from_k3`.
4. **Обновить зависимости**:
   * `K3Interface` объявит метод `get_panel`.
   * `use_cases/panel_use_cases.py` будет использовать его для построения бизнес‑объекта.

---

## 4. План реализации методов `K3Implementation`
| Метод | Описание | Шаги |
|-------|----------|------|
| `get_panel` | Возврат полной модели панели | 1) вызвать `PanelPropertyReader`; 2) преобразовать в доменную сущность; 3) обработать ошибки. |
| `save_panel` | Сохранение изменённой панели в K3 | 1) сериализовать `Panel` → K3‑структура; 2) записать в файл; 3) создать бэкап. |
| `list_panels` | Перечисление всех панелей | 1) сканировать каталог K3‑файлов; 2) собрать имена; 3) вернуть список DTO. |
| `delete_panel` | Удаление панели | 1) проверка зависимостей; 2) удалить файл; 3) обновить индекс. |
| `update_fasteners` | Обновление данных о крепежах | 1) загрузить панель; 2) изменить `FixInfoElems`; 3) сохранить. |
| `calculate_metrics` | Вычисление метрик (площадь, объём, масса) | 1) использовать методы `PolyInfo`, `ElemsInfo`; 2) вернуть DTO. |

Все методы покрыты юнит‑тестами и интеграционными сценариями.

---

## 5. Стратегия тестирования
| Уровень | Цель | Тесты |
|---------|------|-------|
| **Unit** | Проверка отдельных классов и парсеров | `test_entities.py` (новые сущности), `test_property_reader.py` |
| **Integration** | Взаимодействие `K3Implementation` ↔︎ `PanelPropertyReader` ↔︎ файловая система | `test_services.py` (get/save/delete) |
| **Use‑case** | Полные бизнес‑сценарии | `test_use_cases.py` (цепочка операций) |
| **Regression** | Защита от отката | Запуск полного набора тестов при каждом коммите |
| **Coverage** | ≥ 90 % покрытие кода `mDPanel` | CI‑pipeline с `pytest --cov` |

**Ограничения тестирования:**
* **Python 3.7** – использовать только синтаксис и функции, доступные в Python 3.7
* **Модульное тестирование** – pytest с моками K3 модуля, совместимый с Python 3.7
* **Функциональное тестирование** – через обработку сообщений Mebel.exe (интеграция с RabbitMQ)
* **Результаты тестирования** – через журналы/логи приложения или ответные сообщения
* **CI/CD** – локальный запуск тестов, интеграция с внутренней системой сборки

Тесты находятся в `src/Proto/mDPanel/tests/` и запускаются через `pytest` с учетом ограничений Python 3.7.

---

## 6. План документации
| Документ | Содержание | Ответственный |
|----------|------------|----------------|
| **README.md** (корневой) | Описание модуля, требования, установка, запуск тестов | Тех. писатель |
| **src/Proto/mDPanel/README.md** | Архитектурный обзор, диаграммы слоёв, описание сущностей | Архитектор |
| **API‑документация** (Sphinx/Markdown) | Автогенерация из doc‑строк `K3Interface`, `K3Implementation`, сущностей | Разработчик |
| **Guidelines** | Руководство по добавлению новых K3‑методов, правила именования | Архитектор |
| **Changelog** | История изменений, версии 0.1‑0.2‑… | Менеджер релизов |

---

## 7. Реалистичный график (8‑недельный спринт)

| Неделя | Цель | Ключевые задачи |
|--------|------|-----------------|
| **1** | Подготовка | Создать задачи в трекере, настроить CI, добавить базовые тесты. |
| **2** | Дизайн сущностей | Спроектировать `PolyInfo`, `PathInfo`, `ElemsInfo`, `FixInfoElems`; написать юнит‑тесты. |
| **3** | Перенос `PanelRectangle` | Выделить `PanelPropertyReader`, реализовать парсинг, интегрировать в `K3Implementation`. |
| **4** | Реализация K3‑методов (часть 1) | `get_panel`, `list_panels`; тесты интеграции; обновить `K3Interface`. |
| **5** | Реализация K3‑методов (часть 2) | `save_panel`, `delete_panel`; тесты регрессии; бэкапы/откаты. |
| **6** | Расширенные операции | `update_fasteners`, `calculate_metrics`; тесты use‑cases; примеры в `docs/examples.py`. |
| **7** | Полный набор тестов и покрытие | Запуск полного набора, достижение ≥ 90 % coverage, исправление багов. |
| **8** | Документация и релиз | Завершить README, API‑документацию, Changelog; выпустить `v1.0.0`. |

**Риски и ограничения среды**
* **Python 3.7 32-битная** – строгое ограничение версии, избегать функций Python 3.8+
* **Среда Mebel.exe** – код выполняется внутри приложения, интеграция через макроязык K3
* **Платформа Windows** – эксклюзивно для Windows, без кроссплатформенности
* **Геометрические расчёты** – использовать встроенные функции K3 вместо внешних библиотек
* **Тестирование** – модульное тестирование с pytest 3.7, функциональное через RabbitMQ
* **Неоднородный формат K3‑файлов** – покрыть тестами парсинг разных вариантов
* **Регрессия старого кода** – обязательный запуск полного набора тестов

---

## 8. Краткое резюме
1. **Создать новые доменные сущности** (`PolyInfo`, `PathInfo`, `ElemsInfo`, `FixInfoElems`).  
2. **Вынести логику чтения `PanelRectangle`** в сервис `PanelPropertyReader`.  
3. **Заполнить все заглушки в `K3Implementation`** с учётом новой архитектуры.  
4. **Разработать полную тестовую стратегию** (юнит, интеграция, use‑cases, регрессия) и обеспечить высокий уровень покрытия.  
5. **Обновить документацию** и подготовить релиз.  
6. **Следовать 8‑недельному плану**, контролируя прогресс через задачи и CI.

Эти шаги позволят завершить модуль mDPanel, обеспечить его надёжность и готовность к интеграции в основной проект.